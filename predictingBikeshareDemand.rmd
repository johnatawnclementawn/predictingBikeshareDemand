---
title: "Predicting Bikeshare Demand"
author: "Johnathan Clementi"
date: "11/19/2021"
output:
  rmdformats::downcute:
    self_contained: true
    thumbnails: true
    lightbox: false
    gallery: false
    highlight: tango
---

```{r setup}
knitr::opts_chunk$set(
	error = FALSE,
	message = FALSE,
	warning = FALSE,
	cache = TRUE,
	include = FALSE
)

library(tidyverse)
library(sf)
library(lubridate)
library(tigris)
library(gganimate)
library(riem)
library(gridExtra)
library(knitr)
library(kableExtra)
library(rmdformats)

options(tigris_class = "sf")
source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")

palette5 <- c("#eff3ff","#bdd7e7","#6baed6","#3182bd","#08519c")
palette4 <- c("#D2FBD4","#92BCAB","#527D82","#123F5A")
palette2 <- c("#6baed6","#08519c")
```


# 2 Data Wrangling

Capital Bikeshare ride data obtained from this [link](https://s3.amazonaws.com/capitalbikeshare-data/index.html)
More information about these data can be found at this [link](https://www.capitalbikeshare.com/system-data)
```{r include=FALSE}
# Rideshare data were previously downloaded for April, May, and June of 2019 (Pre-pandemic) from the link above.
root.dir = "D:/Users/Johnathan/Google Drive/Grad School/PennDesign_MUSA/PublicPolicyAnalytics/predictingBikeshareDemand/data"

crs <- 'ESRI:102285' #StatePlane Maryland
```

### Capital Bikeshare Data
```{r}
rides <- rbind(#read.csv(file.path(root.dir,"202108-capitalbikeshare-tripdata.csv")),
              read.csv(file.path(root.dir,"202109-capitalbikeshare-tripdata.csv")),
              read.csv(file.path(root.dir,"202110-capitalbikeshare-tripdata.csv"))
              )

# Retrieve location data for Capital Bikeshare dock locations
# Remove regions except for Washington DC because we don't have the computational resources for analyzing the entire population of bikeshare locations
# Why do station_id's not match up?????
docks <- st_read("https://opendata.arcgis.com/datasets/a1f7acf65795451d89f0a38565a975b3_5.geojson") %>%
  st_transform(crs) %>%
  # mutate(STATION_ID = paste0("31", STATION_ID)) %>% # Add prefix to station id's
  # mutate(STATION_ID = as.integer(STATION_ID)) %>%
  dplyr::select(OBJECTID, LATITUDE, LONGITUDE, NAME, CAPACITY, REGION_NAME) %>%
  filter(REGION_NAME == "Washington, DC")
```


```{r}
rides <- rides %>%
  mutate(started_at = ymd_hms(started_at),
         ended_at = ymd_hms(ended_at),
         interval60 = floor_date(ymd_hms(started_at), unit = "hour"),
         interval15 = floor_date(ymd_hms(started_at), unit = "15 mins"),
         week = week(interval60),
         dotw = wday(interval60, label=TRUE)
        ) %>%
  mutate(time_of_day = case_when(hour(interval60) < 7 | hour(interval60) > 18 ~ "Overnight",
                                 hour(interval60) >= 7 & hour(interval60) < 10 ~ "AM Rush",
                                 hour(interval60) >= 10 & hour(interval60) < 15 ~ "Mid-Day",
                                 hour(interval60) >= 15 & hour(interval60) <= 18 ~ "PM Rush")
        )
```



### 2.1 Filter rides without stations
```{r}

rides <- dplyr::left_join(rides, docks %>% st_drop_geometry(), by =c("start_station_name" = "NAME")) %>%
            select(-LONGITUDE, - LATITUDE, -OBJECTID, -REGION_NAME) %>%
            rename(start_station_capacity = CAPACITY) %>%
            na.omit()

rides <- dplyr::left_join(test, docks %>% st_drop_geometry(), by =c("end_station_name" = "NAME")) %>%
            select(-LONGITUDE, - LATITUDE, -OBJECTID) %>%
            rename(end_station_capacity = CAPACITY) %>%
            na.omit()

```

### 2.2 Weather Data
```{r}
# riem_networks <- riem_networks()
# vaStations <- riem_stations("VA_ASOS") %>%
#   st_as_sf(coords = c("lon","lat"), crs=crs)
# mdStations <- riem_stations("MD_ASOS") %>%
#   st_as_sf(coords = c("lon","lat"), crs=crs)
# The closest weather station to our study area is at Reagan National Airport - "DCA"

weather.Data <- 
  riem_measures(station = "DCA", date_start = "2021-09-01", date_end = "2021-10-31")

weather.Panel <-  
  weather.Data %>%
    mutate_if(is.character, list(~replace(as.character(.), is.na(.), "0"))) %>% 
    replace(is.na(.), 0) %>%
    mutate(interval60 = ymd_h(substr(valid, 1, 13))) %>%
    mutate(week = week(interval60),
           dotw = wday(interval60, label=TRUE)) %>%
    group_by(interval60) %>%
    summarize(Temperature = max(tmpf),
              Precipitation = sum(p01i),
              Wind_Speed = max(sknt)) %>%
    mutate(Temperature = ifelse(Temperature == 0, 42, Temperature))

grid.arrange(top = "Weather Data - Washington, DC - September - October, 2021",
  ggplot(weather.Panel, aes(interval60,Precipitation)) + geom_line() + 
    labs(title="Precipitation", x="Hour", y="Precipitation") + plotTheme(),
  ggplot(weather.Panel, aes(interval60,Wind_Speed)) + geom_line() + 
    labs(title="Wind Speed", x="Hour", y="Wind Speed") + plotTheme(),
  ggplot(weather.Panel, aes(interval60,Temperature)) + geom_line() + 
    labs(title="Temperature", x="Hour", y="Temperature") + plotTheme())
```

# 3 Visualizations

### 3.1 View ridership over time
```{r fig.width=12, fig.height=6}
ggplot(rides %>%
       group_by(interval60) %>%
       tally())+
  geom_line(aes(x = interval60, y = n))+
  labs(title="Capital Bikeshare trips per hr. Washington, DC, September-October 2021",
       x="Date", 
       y="Number of trips") +
  plotTheme()

```

```{r fig.width=12, fig.height=6}
rides %>%
  group_by(interval60, start_station_name, time_of_day) %>%
         tally() %>%
  filter(n < 25) %>%
  group_by(start_station_name, time_of_day) %>%
  summarize(mean_trips = mean(n)) %>%
  ggplot() +
    geom_histogram(aes(mean_trips), binwidth = 1)+
    labs(title="Mean Number of Hourly Trips Per Station. Washington DC, September-October, 2021",
         x="Number of trips", 
         y="Frequency")+
    facet_wrap(~factor(time_of_day,levels=c("AM Rush", "Mid-Day", "PM Rush", "Overnight"))) +
  plotTheme()
```

```{r fig.width=10}
ggplot(rides) +
  geom_freqpoly(aes(hour(started_at), color = dotw), binwidth = 1) +
  labs(title="Bike share trips in Washington DC, by day of the week, September-October, 2021",
       x="Hour", 
       y="Trip Counts") +
  plotTheme()


ggplot(rides %>% mutate(weekend = ifelse(dotw %in% c("Sun", "Sat"), "Weekend", "Weekday"))) +
  geom_freqpoly(aes(hour(started_at), color = weekend), binwidth = 1) +
  labs(title="Bike share trips in Washington DC, by day of the week, September-October, 2021",
       x="Hour", 
       y="Trip Counts") +
  plotTheme()
```


